(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.reg.get("core","common/extend");let o,n;const r=new WeakMap,a=new WeakMap,s=new WeakMap,i=new WeakMap,c=new WeakMap;let p={get(t,e,o){if(t instanceof IDBTransaction){if("done"===e)return a.get(t);if("objectStoreNames"===e)return t.objectStoreNames||s.get(t);if("store"===e)return o.objectStoreNames[1]?void 0:o.objectStore(o.objectStoreNames[0])}return l(t[e])},set:(t,e,o)=>(t[e]=o,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function u(t){return"function"==typeof t?(e=t)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(){for(var t=arguments.length,o=new Array(t),n=0;n<t;n++)o[n]=arguments[n];return e.apply(d(this),o),l(r.get(this))}:function(){for(var t=arguments.length,o=new Array(t),n=0;n<t;n++)o[n]=arguments[n];return l(e.apply(d(this),o))}:function(t){for(var o=arguments.length,n=new Array(o>1?o-1:0),r=1;r<o;r++)n[r-1]=arguments[r];const a=e.call(d(this),t,...n);return s.set(a,t.sort?t.sort():[t]),l(a)}:(t instanceof IDBTransaction&&function(t){if(a.has(t))return;const e=new Promise(((e,o)=>{const n=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",a),t.removeEventListener("abort",a)},r=()=>{e(),n()},a=()=>{o(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",r),t.addEventListener("error",a),t.addEventListener("abort",a)}));a.set(t,e)}(t),i=t,(o||(o=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>i instanceof t))?new Proxy(t,p):t);var e,i}function l(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,o)=>{const n=()=>{t.removeEventListener("success",r),t.removeEventListener("error",a)},r=()=>{e(l(t.result)),n()},a=()=>{o(t.error),n()};t.addEventListener("success",r),t.addEventListener("error",a)}));return e.then((e=>{e instanceof IDBCursor&&r.set(e,t)})).catch((()=>{})),c.set(e,t),e}(t);if(i.has(t))return i.get(t);const e=u(t);return e!==t&&(i.set(t,e),c.set(e,t)),e}const d=t=>c.get(t),f=["get","getKey","getAll","getAllKeys","count"],w=["put","add","delete","clear"],g=new Map;function v(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(g.get(e))return g.get(e);const o=e.replace(/FromIndex$/,""),n=e!==o,r=w.includes(o);if(!(o in(n?IDBIndex:IDBObjectStore).prototype)||!r&&!f.includes(o))return;const a=async function(t){const e=this.transaction(t,r?"readwrite":"readonly");let a=e.store;for(var s=arguments.length,i=new Array(s>1?s-1:0),c=1;c<s;c++)i[c-1]=arguments[c];n&&(a=a.index(i.shift()));const p=await a[o](...i);return r&&await e.done,p};return g.set(e,a),a}var h;h=p,p={...h,get:(t,e,o)=>v(t,e)||h.get(t,e,o),has:(t,e)=>!!v(t,e)||h.has(t,e)};const b=flarum.reg.get("core","common/components/Page");var k=t.n(b);const y=flarum.reg.get("core","common/components/LinkButton");var _=t.n(y);const B=flarum.reg.get("core","forum/components/SessionDropdown");var N=t.n(B);const P=flarum.reg.get("core","common/utils/extractText");var x=t.n(P);const D=flarum.reg.get("core","forum/utils/DiscussionControls");var I=t.n(D);const L=flarum.reg.get("core","forum/utils/PostControls");var S=t.n(L);const E=flarum.reg.get("core","forum/utils/UserControls");var M=t.n(E);const C=flarum.reg.get("core","common/components/Button");var A=t.n(C);async function j(t){try{const e=x()(t.title);await navigator.share({title:e,url:t.url}),resultPara.textContent="MDN shared successfully"}catch(t){console.log("Error: "+t)}}const O=flarum.reg.get("core","common/components/Alert");var W=t.n(O);const T=flarum.reg.get("core","common/components/Link");var q=t.n(T);const F=flarum.reg.get("core","common/components/Icon");var K=t.n(F);const U="push-token",H="push-permission-request",R="push-permission-state",V=()=>window.webkit&&window.webkit.messageHandlers,z=t=>app.sw.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:app.forum.attribute("vapidPublicKey")}).then((e=>{t&&app.request({method:"POST",url:app.forum.attribute("apiUrl")+"/pwa/push",body:{subscription:e}})})),G=()=>{if(!app.session.user)return!1;const t=app.session.user.preferences();let e;for(e in t)if(("string"==typeof e||e instanceof String)&&e.startsWith("notify_")&&e.endsWith("_push")&&t[e])return!0;return!1},J=()=>app.forum.attribute("vapidPublicKey");let{registerFirebasePushNotificationListeners:$,removeFirebasePushNotificationListeners:Q,firebasePushNotificationState:X,hasFirebasePushState:Y}=(()=>{let t="granted";const e=e=>{"granted"===e.detail&&(t="granted",window.webkit.messageHandlers[U].postMessage(U))},o=t=>{app.request({method:"POST",url:app.forum.attribute("apiUrl")+"/pwa/firebase-push-subscriptions",body:{token:t.detail}})},n=e=>{t=e.detail,m.redraw()};return{hasFirebasePushState:e=>e===t,registerFirebasePushNotificationListeners:function(){V()&&(window.webkit.messageHandlers[R].postMessage(R),window.addEventListener(H,e),window.addEventListener(R,n),window.addEventListener(U,o))},removeFirebasePushNotificationListeners:function(){V()&&(window.removeEventListener(H,e),window.removeEventListener(R,n),window.removeEventListener(U,o))}}})();app.initializers.add("askvortsov/flarum-pwa",(()=>{(0,e.extend)(k().prototype,"oninit",(()=>{const t=app.forum.attribute("basePath").trimRight("/");(async()=>{const e=function(t,e,o){let{blocked:n,upgrade:r,blocking:a,terminated:s}=void 0===o?{}:o;const i=indexedDB.open("keyval-store",1),c=l(i);return r&&i.addEventListener("upgradeneeded",(t=>{r(l(i.result),t.oldVersion,t.newVersion,l(i.transaction))})),n&&i.addEventListener("blocked",(()=>n())),c.then((t=>{s&&t.addEventListener("close",(()=>s())),a&&t.addEventListener("versionchange",(()=>a()))})).catch((()=>{})),c}(0,0,{upgrade(t){t.createObjectStore("keyval")}});(await e).put("keyval",app.forum.data.attributes,"flarum.forumPayload"),"serviceWorker"in navigator&&navigator.serviceWorker.register(t+"/sw",{scope:t+"/"}).then((t=>{navigator.serviceWorker.ready.then((()=>{app.sw=t,(async t=>{if(!app.cache.pwaRefreshed&&"Notification"in window&&"granted"===window.Notification.permission&&G())try{await z(!0)}catch(e){if(!t.pushManager)return;t.pushManager.getSubscription().then((t=>t.unsubscribe().then(z.bind(void 0,!0))))}app.cache.pwaRefreshed=!0})(t)}))}))})()})),(0,e.extend)(N().prototype,"items",(t=>{(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://"))&&t.has("administration")&&(t.remove("administration"),t.add("administration",_().component({icon:"fas fa-wrench",href:app.forum.attribute("adminUrl"),target:"_self",external:!0},app.translator.trans("core.forum.header.admin_button"))))})),(0,e.extend)(I(),"userControls",(function(t,e){navigator.share&&t.add("share",A().component({icon:"fas fa-share-square",onclick:()=>j({title:e.title(),url:window.location.protocol+"//"+window.location.hostname+app.route.discussion(e)})},app.translator.trans("askvortsov-pwa.forum.discussion_controls.share_button")),-1)})),(0,e.extend)(S(),"userControls",(function(t,e){navigator.share&&t.add("share",A().component({icon:"fas fa-share-square",onclick:()=>j({title:app.translator.trans("askvortsov-pwa.forum.post_controls.share_api.title",{username:e.user().displayName(),title:e.discussion().title()}),url:window.location.protocol+"//"+window.location.hostname+app.route.post(e)})},app.translator.trans("askvortsov-pwa.forum.post_controls.share_button")),100)})),(0,e.extend)(M(),"userControls",(function(t,e){navigator.share&&t.add("share",A().component({icon:"fas fa-share-square",onclick:()=>j({title:e.displayName(),url:window.location.protocol+"//"+window.location.hostname+app.route.user(e)})},app.translator.trans("askvortsov-pwa.forum.user_controls.share_button")),100)})),(0,e.extend)(k().prototype,"oncreate",(()=>{if(!J())return;const t=()=>{localStorage.setItem("askvortov-pwa.notif-alert.dismissed",JSON.stringify({timestamp:(new Date).getTime()}))};app.alerts.dismiss(app.cache.pwaNotifsAlert),!localStorage.getItem("askvortov-pwa.notif-alert.dismissed")&&"Notification"in window&&"default"===window.Notification.permission&&G()&&(app.cache.pwaNotifsAlert=app.alerts.show({controls:[m(q(),{class:"Button Button--link",href:app.route("settings"),onclick:()=>t()},app.translator.trans("askvortsov-pwa.forum.alerts.optin_button"))],ondismiss:t},app.translator.trans("askvortsov-pwa.forum.alerts.optin")))})),(0,e.extend)("flarum/forum/components/NotificationGrid","notificationMethods",(function(t){J()&&t.add("push",{name:"push",icon:"fas fa-mobile",label:app.translator.trans("askvortsov-pwa.forum.settings.push_header")})})),(0,e.extend)("flarum/forum/components/SettingsPage","notificationsItems",(function(t){if(!V()&&J())if("Notification"in window)if("default"===window.Notification.permission){if(!J())return;t.add("push-optin-default",W().component({itemClassName:"pwa-setting-alert",dismissible:!1,controls:[A().component({className:"Button Button--link",onclick:()=>{window.Notification.requestPermission((t=>{m.redraw(),"granted"===t&&z(!0)}))}},app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.access_default_button"))]},[m(K(),{name:"fas fa-exclamation-circle"}),app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.access_default")]),10)}else"denied"===window.Notification.permission&&t.add("push-optin-denied",W().component({itemClassName:"pwa-setting-alert",dismissible:!1,type:"error",controls:[m("a",{class:"Button Button--link",href:"https://support.humblebundle.com/hc/en-us/articles/360008513933-Enabling-and-Disabling-Browser-Notifications-in-Various-Browsers"},app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.access_denied_button"))]},[m(K(),{name:"fas fa-exclamation-triangle"}),app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.access_denied")]),10);else t.add("push-no-browser-support",W().component({dismissible:!1,controls:[m("a",{class:"Button Button--link",href:"https://developer.mozilla.org/en-US/docs/Web/API/Push_API"},app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.no_browser_support_button"))]},[m(K(),{name:"fas fa-exclamation-triangle"}),app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.no_browser_support")]),10)})),(0,e.extend)("flarum/forum/components/SettingsPage","notificationsItems",(function(t){V()&&(Y("authorized")||t.add("firebase-push-optin-default",W().component({itemClassName:"pwa-setting-alert",dismissible:!1,controls:[A().component({className:"Button Button--link",onclick:()=>window.webkit.messageHandlers[H].postMessage(H)},app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.access_default_button"))]},[m(K(),{name:"fas fa-exclamation-circle"}),app.translator.trans("askvortsov-pwa.forum.settings.pwa_notifications.access_default")]),10))})),(0,e.extend)("flarum/forum/components/SettingsPage","oncreate",(function(){$()})),(0,e.extend)("flarum/forum/components/SettingsPage","onremove",(function(){Q()}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map